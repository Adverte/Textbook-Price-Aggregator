{% extends "base.html" %}
   
{% block head %}
<script type="text/javascript" src="/js/util.js"></script>
<script type="text/javascript" src="/js/objects.js"></script>

<style type="text/css">
.highlight-orange {
    background: orange;
}

#textbook, #listings {
    position: relative;
}

.small_overlay_container {
    min-height: 150px;
}
</style>

<script type="text/javascript">
var path = window.location.pathname;
var trimpath = (path.slice(-1) == '/') ? path.slice(0,-1) : path;
var isbn = trimpath.split('/').slice(-1);

var retailers;
var textbook;
var listingsdata = [];
var done = [];

var listing_headers = ['retailer', 'condition', 'price', ''];

$(function () {
    $('#sort').change(function() {
        sort_listings($(this).val());
    }).attr('disabled', 'disabled');
    get_textbook();
    get_retailers();
});

function sort_listings(attrs) {
    listingsdata.sort(textbooklistings.cmp_factory(attrs));
    $('#tblistings tbody tr').remove();
    output_listing_body(listingsdata, '#tblistings tbody');
}

function get_textbook() 
{
    var overlay_container = 'div#textbook';
    $.ajax({
        url:'{{ url }}',
        dataType: 'json',
        success: function(data) {
            textbook = data;
            output_textbook(data,'div#textbook'); 
        },
        beforeSend: function(jpXHR, settings) {
            $('<div />').appendTo(overlay_container)
                        .addClass('overlay loader_img')
                        .addClass('small_overlay_container')
                        .attr('id', 'textbook_overlay')
                        .hide();
            $(overlay_container).addClass('small_overlay_container');
            $('#textbook_overlay').fadeIn();
        },
        complete: function(jqXHR, textStatus) {
            $('#textbook_info').slideDown('slow', function () { //TODO doesn't work as expected b/c height of div is not full height of image.
                $('#textbook_overlay').fadeOut('slow', function() {
                    $(overlay_container).removeClass('small_overlay_container');
                    $(this).remove();
                });
            });
        }
    });
}

function output_textbook(data, selector)
{
        var container_id = 'textbook_info';
        var container_sel = '#' + container_id;

        $('<div id="'+container_id+'" />').hover(function() {
            $(this).addClass('highlight-orange');
        }, function() {
            $(this).removeClass('highlight-orange');
        }).addClass('clickable')
          .appendTo(selector)
          .hide();

        var imghtml = '<img class="bookimage" src="' + data.imageurl +'"></img>';
        $('<span />').append(imghtml).appendTo(container_sel);
        var linkhtml = '<a class="top" href="' + data.url +'">' + data.title + '</a>';
        $('<span />').append(linkhtml).appendTo(container_sel);

        $('<hr class="clear"/>').appendTo(selector);
        $("div.clickable").click( function() {
            window.location = $(this).find('a').attr('href');
            return false;
        });
}

function get_retailers() 
{
    $.ajax({
        url: '/retailers',
        dataType: 'json',
        success: function(data) {
            retailers = data;
            notdone = data
            get_listings();
        }
    });
}

function get_listings() 
{
    var overlay_container = '#listings';
    var begun = false;
    $.each(retailers, function(index, retailer) {
        $.ajax({
            url: '/textbooklistings/' + retailer + '/' + isbn,
            dataType: 'json',
            success: function (data) 
            {
                listingsdata = listingsdata.concat(data);
                done.push(retailer);
                
                if (retailers.length == done.length)  {
                    output_listing_table(listingsdata);
                    sort_listings(['condition', 'price'])
                    $('#sort').attr('disabled', '');
                }
            },
            beforeSend: function(jpXHR, settings) 
            {
                if (!begun) {
                    begun = true;
                    $('#tblistings').hide();
                    
                    $('<div />').appendTo(overlay_container)
                                .addClass('overlay loader_img')
                                .attr('id', 'listings_overlay')
                                .hide();
                    $(overlay_container).addClass('overlay_container');
                    $('#listings_overlay').fadeIn();
                }
            },
            complete: function(jqXHR, textStatus) 
            {
                if (done.length == retailers.length) 
                {
                    $('#tblistings').slideDown('slow', function () { //TODO doesn't slide down correctly
                        $('#listings_overlay').fadeOut('slow', function() {
                            $(overlay_container).removeClass('overlay_container');
                            $(this).remove()
                        });
                    });
                }
            }
        });
    });
}

function output_listing_table (data) 
{    
    output_listing_header('#tblistings thead');
    output_listing_body(listingsdata, '#tblistings tbody');
}

function output_listing_header(container) 
{
    theader_row = $('<tr />').appendTo(container);
    
    $.each(listing_headers, function(index, header) {
        $('<th />').append(header)
                   .appendTo(theader_row);
    });
}

function output_listing_body(data, container) {
    $.each(data, function(index, listing) {
        output_listing_row(listing, container);
    });
}

function output_listing_row(listing, container)
{ 
    listing_row = $('<tr />').hover(function () {
        $(this).addClass('highlight');
    }, function () {
        $(this).removeClass('highlight');
    }).click(function () {
        window.location = $(this).find('button').val();
    }).addClass('clickable')
      .appendTo(container);
    
    $.each(listing_headers, function(index, header) {
        td = $('<td />').appendTo(listing_row);

        if (header == '') 
            $('<button />').click(function () {
                window.location = $(this).val();
            }).attr({
                'name': 'product_link',
                'value': listing['url']
            }).append('Buy Now')
              .appendTo(td);
        else if (header == 'price')
            td.append(util.format_currency(listing[header], '$'));
        else 
            td.append(listing[header]);
    });
}
</script>
{% endblock head %}

{% block content %}
<div id="textbook"></div> <!-- //TODO: create header for book, loading gif next to it -->
<div id="listings">
    <label for="sort">Sort By:</label>
    <select name="sort" id="sort">
        <option value="price">Price</option>
        <option value="condition">Condition</option>
        <option value="retailer">Retailer</option>
    </select> <!-- //TODO: loading gif next to this -->
    <!-- <a href="">Add Sort Condition</a> //TODO -->
    <table id="tblistings" summary="Textbook listings for the textbook (ISBN) of this page">
        <thead></thead>
        <tbody></tbody>
    </table>
</div>
{% endblock %}